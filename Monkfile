#gather up all .csv files except those already gathered.
--command cp
--input --match '.*(?<!modeling)/([^/]*)\.csv$'
--output 'modeling/{0}.csv'

#gather raw trial data and put them in CSV files
--command            Rscript
--input              make_csv.R
--input --match      'collections/(.*)\.list'
                     discrimination.sqlite
--input --invisible  discrimination.sqlite.DONE
--output             modeling/{0}_trials.csv
--input              motion_energy.mat

#collect the motion energy data in another file (as it has a grid)
--command            Rscript
--input mat2csv.R
--input --match (motion_energy)\.mat
--output modeling/{0}.csv

#make a few plots relevant to motion ehergy
--command Rscript
--input modeling/motion_energy_plot.R
--input --match motion_energy\.csv
--output motion_energy.pdf

#plot threshold values
--command            --once ./runmatlab
--input --invisible  modeling/plotThresholds.m
--once               "\"addpath('modeling');\" plotThresholds"
--input --match      'modeling/.*_series_calculations.csv'
--output --invisible modeling/plotThresholds.fig

#type "make figures" to try to refresh the figures
--command --input --invisible --match '.*\.fig$'
--output --invisible --phony figures

#matlab stuff requires we unpack all the data into a matlab file.
--command --once ./runmatlab --once "\"addpath('modeling');\" unpack"
--input --invisible --once modeling/unpack.m
--input --match modeling/(.*_trials\.csv)$
--output --invisible --once modeling/data.mat

#might as well unpack into an R data file.
--command --once cd --once modeling --once && --once Rscript
--once --input --invisible modeling/unpack.R --once unpack.R
--output --invisible --once modeling/data.RData --once data.RData
--input --match --invisible modeling/(.*_trials\.csv) {0}

#the model-fitting function
#--command ./runmatlab "\"addpath('modeling'); MeilstrupBoyntonModel\""
#--input --invisible modeling/MeilstrupBoyntonModel.m
#--input --invisible --match "modeling/data\.mat"
#--output --invisible modeling/modelResults.mat

#and let's start translating this to R also.
--command --once Rscript --input modeling/MeilstrupBoyntonModel.R
--input --match 'modeling/data\.Rd'
--output --once modeling/result.Rd
--output --invisible modeling/modelResults.mat

#and let's start translating this to R also.
--command --once Rscript --input modeling/MeilstrupBoyntonModel.R
--input --match 'modeling/data\.Rd'
--output --once modeling/result.Rd

#fit all the models
--command ./runmatlab --once "\"addpath('modeling'); fitAll\""
--input --invisible modeling/fitAll.m
--input --match 'modeling/data\.mat'
--output 'modeling/fits.mat'

#plot all the fits
#
#TODO: --intermediate does not respect --listing files
#appropriately. Furthermore multiple outputs inappropriately result in
#multiple commands issued from Make. THis results in a bunch of
#repeated commands...
--command --once ./runmatlab --once "\"addpath('modeling'); plotFits\""
--input --invisible modeling/plotFits.m
--input --match 'modeling/fits\.mat'
--output --listing --intermediate 'modeling/fit_plots.list'

#bundle them all into a multipage PDF
--command --once pdfjoin
--once %--outfile
--once --output 'modeling/fits_{0}.pdf'
--input --match 'modeling/fit_(.*)_.*\.pdf$'
--invisible --phony --once figures

#make diagnostic figures?
--command ./runmatlab "\"addpath('modeling'); makeDiagnostics\""
--input --match 'modeling/fits\.mat'
--output --listing 'modeling/diagnosticPlots.pdf'
--invisible --phony --once figures

#and bundle them
--command --once pdfjoin
--once %--outfile
--once --output 'modeling/residuals_{0}_plots.pdf'
--input --match 'modeling/residual_(.*)_.*\.pdf$'
--invisible --phony --once figures

#grab our motion energy demo movie
--command cp
--input --match (deltax\.mov)
--output modeling/energy/{0}

#make our motion energy graphs
--command cd modeling && Rscript
--input --invisible modeling/motion_energy_plot.R motion_energy_plot.R
--input --invisible --match modeling/motion_energy\.csv motion_energy.csv
--output --listing --invisible modeling/energy/motion_energy_plot.list energy/motion_energy_plot.list

--command cd modeling && Rscript
--input --invisible modeling/slopeModel.R slopeModel.R
--input --invisible --match modeling/data\.RData data.RData
--output --invisible modeling/slopeModel.RData slopeModel.RData

--command
--input --match --invisible modeling/.*
--output --once --invisible --phony modeling
