#use dependency discovery for R/MATLAB
@monk/autodep/dependencies.monkfile

#make a few plots relevant to motion ehergy

--command Rscript
--input motion_energy_plot.R
--input --match motion_energy\.csv
--output motion_energy_plot.pdf

#type "make figures" to try to refresh the figures
#--command --input --invisible --match '.*\.fig$'
#--invisible --phony figures

#Unpack all data into an R data file.
--command --once Rscript
--input --once unpack.R
--output --once data.RData
--input --match (.*_trials\.csv)

#make our motion energy graphs
--command Rscript
--input motion_energy_plot.R$
--input --match motion_energy.csv
--output --listing --mkdir energy/motion_energy_plot.list

--command Rscript
--input slopeModel.R
--input --match data.RData
--input motion_energy.csv
--output slopeModel.RData
--output slopeModel.pdf

--command Rscript
--input density.calibration.R
--input --match data.RData
--input slopeModel.RData
--output density.calibration.pdf

--command Rscript
--input --match "density.modeling.R$"
--input data.RData
--input slopeModel.RData
--output density.modeling.pdf
--output density.modeling.RData

--command Rscript
--input combined.model.R
--input --match slopeModel\.RData
--input density.modeling.RData
--input motion_energy.csv
--output combined.model.RData
--output combined.model.pdf
--phony --invisible pdf

--command Rscript # without folding
--input contours.R
--input --match slopeModel\.RData$
--input motion_energy.csv
--output --mkdir --listing contours/contours.list FALSE

--command --invisible --match --input contours/.*.pdf
--phony --invisible pdf

--command Rscript # with folding
--input contours.R
--input --match slopeModel.RData$
--input motion_energy.csv
--output --mkdir --listing contours/contours_folded.list TRUE
--phony --output --invisible intermediate_pdf

#how about markov chain monte carlo?
--command RScript --input compileStan.R
--input --match (.*\.stan)\.R$
--output {0}.RData
--invisible --phony stan

--command Rscript --input --match (NineModels).R$
--output --listing {0}.list
--invisible --phony stan

--command Rscript --input StanModel.R
--input data.RData
--input motion_energy.csv
--input --match (.*).stan\.RData$
--output {0}.fit.RData
--invisible --phony fit

#some models are not baked yet, or need extra samples
#--command
#--output --match --invisible (CenterSurroundModel)\.fit\.RData$ 500

--command
--output --match --invisible (models/.*)\.fit\.RData$ 1000 --invisible --phony nine

--command
--output --match --invisible (ProportionalMotionEnergy)\.fit\.RData$ 4000

--command Rscript --input FitPlots.R
--input --match (.*)\.fit\.RData
--input motion_energy.csv
--output {0}.plots.pdf
--invisible --phony plot

# MotionEnergyLinear|MotionEnergySoftMin|

--command --once Rscript --input --once CompareStanFits.R
--output --once StanComparisonCircles.pdf
--input --match --once (OnlyMotionEnergy|SlopeModel|SoftMinModel)\.fit\.RData$
--invisible --phony plot

--command --once Rscript --input --once CompareStanFits.R
--output --once StanComparisonCircles.pdf
--input --match --once (OnlyMotionEnergy|SlopeModel|SoftMinModel)\.fit\.RData$
--invisible --phony plot

--command --once Rscript --input --once CompareStanFits.R
--output --once StanComparisonEnergies.pdf
--input --match --once (ProportionalMotionEnergy|SlopeModel|MotionEnergyRepulsion|OnlyMotionEnergy)\.fit\.RData$
--invisible --phony plot
--invisible --phony compare

--command --once Rscript --input --once CompareStanFits.R
--output --once StanComparisonCombined.pdf
--input --match --once (Hemifield|SummationField)\.fit\.RData$
--invisible --phony plot
--invisible --phony compare

--command --once Rscript --input --once CompareStanFits.R
--output --once models/comparison_d_{0}.pdf
--input --match models/d_([a-z_]*)_c_([a-z_]*)\.fit\.RData$
--invisible --phony plot
--invisible --phony compare

--command --once Rscript --input --once CompareStanFits.R
--output --once models/comparison_c_{1}.pdf
--input --match models/d_([a-z_]*)_c_([a-z_]*)\.fit\.RData$
--invisible --phony plot
--invisible --phony compare

#--command Rscript --input --once StanResiduals.R

--command pdfjoin %--rotateoversize 'false'
%--outfile --output contours/all_contours.pdf
'$$(' cat --input --match --listing contours/contours.list ')'
#--phony --invisible intermediate_pdf

--command pdfjoin %--rotateoversize 'false'
%--outfile --output contours/all_contours_folded.pdf
'$$(' cat --input --match --listing contours/contours_folded.list ')'
#--phony --invisible intermediate_pdf

--command '$(LYX)' %-e knitr --input --match ^([^_/][^/]*)\.lyx$
--output --invisible {0}.Rnw

--command '$(LYX)' %-e latex --input --match (_master)\.lyx
--output --invisible {0}.tex

--command Rscript %-e "\"library(knitr); knit('{0}{1}.Rnw', '{1}.tex')\""
--input --invisible --match ((?:.*/)?)([^_].*)\.Rnw
--output --invisible --once {0}{1}.tex

--command --invisible --input --match (.*)_weave\.R$
--output --invisible --once {0}.tex

--command ( cd ./{0} && latexmk
%-pdf %-pdflatex='pdflatex -halt-on-error -interaction=nonstopmode'
--input --match --invisible ((?:.*/)?)([^_].*)\.tex$ {1}.tex
#--input --listing --invisible {0}.in
--input --invisible _preamble.tex
--output --invisible {0}{1}.pdf
--output --invisible {0}{1}.fls
--phony --invisible latex
--invisible --phony pdf
--invisible --input intermediate_pdf )

--command grep '^INPUT' --match --input (.*)\.fls
| cut %-d "' '" %-f 2- > --output {0}.in

--command grep '^OUTPUT' --match --input (.*)\.fls
| cut %-d "' '" %-f 2- > --output {0}.prod

--command Rscript --input --match '(.*)_weave.R$' --output {0}_plots.pdf
--phony --invisible pdf

#compile graffle figures...
--command osascript --input og-export.applescript 
$(abspath --input --match --invisible (.*).graffle((?=/data\.plist|$)) {0}.graffle ) 
$(abspath --output {0}.pdf ) pdf
--phony --invisible graffles 
--phony --invisible intermediate_pdf

#model.graffle includes some "inset" files as insets
--command --output --invisible --once model.pdf
--input --invisible --match inset_.*\.pdf

#everything plots depends on this generated file
--command --output --invisible --match everything\.tex
--input --invisible sensitivity-plot.RData

#which is updated when this is updated...
--command --output --invisible --match sensitivity-plot\.RData
--output --invisible results.tex
